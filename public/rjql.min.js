!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):(e=e||self,r(e.rjql={}))}(this,function(e){"use strict";function r(e,r,t){var n=!0;if(t){for(a=0;a<e.length;a++)if(e[a][t]!=r[a][t]){n=!1;break}}else for(var a=0;a<e.length;a++)if(e[a]!=r[a]){n=!1;break}return n}function t(e){var r={};for(var t of e)r[t=t.replace(/^'/,"").replace(/'$/,"")]="_";return r}function n(e,r,t,n,a){switch(a){case"=":return"Expected <i>"+r+"</i> to be <b>"+t+"</b> found <u>"+n+"</u>";case"~":return"Value <b>"+t+"</b> was not found in array <i>"+r+"</i>["+n+"]";case"<>":return"Found <i>"+r+"</i> with value <b>"+t+"</b>, while not expecting it.";default:return"Query <b>"+e+"</b> failed for value <u>"+n+"</u>"}}function a(e,r){var t={},n=[];if(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){return o(t),t}if("object"!=typeof e)return o(t),t;for(var a=0;a<r.length;a++){var u=V.getEmptyResult();if(n.push(u),"C"!=r[a].qType)if(s(e,r[a],u),u.target&&!u.passed){var i=V.getEmptyResult();for(var c of r[a].children)s(u.target,c,i);u.verb=i.verb}else u.passed&&(u.verb="OK");else n[a-1].next=r[a].query}}return n}function s(e,r,t){if(r.query=r.query.replace(/(\[\])?:$/,""),"E"===r.qType)u(r,e,t);else{var n=V.traverse(e,r.query.split(">"));if("N"===r.qType){for(var a of r.children)if(s(n,a,t),t.passed)break}else{var o=!1;for(var c of n){var v=!1;for(var a of r.children){var l=V.getAggregationFunction(a.query);if(l){i(l,a,n,t),o=!0,v=!0;break}if(s(c,a,t),!t.passed){v=!0;break}}if(!v&&t.passed&&(t.target=c),o){o&&r.children.length>1&&(t.warn="Ignoring rest of the queries after Aggregation function.");break}if(!v&&"<>"!=t.operator)break;if("<>"==t.operator&&v)break}}}}function u(e,r,t){return e.q=e.query,e.getLineNo=function(){return this.start},K(e,r,t,e)}function i(e,r,t,n){var a=e(r.query,t);a.status?n.target=t:(n.passed=a.status,n.verb=a.verb,n.errLineNo=r.start)}function o(e){e.verb="The response is not a valid JSON. <b>RJQL</b> works only for JSON. ",e.passed=!1}function c(e){try{var r=e.split("\n"),t=l(r);for(var n of t)"C"!=n.qType&&v(n,r,n.start++,n.end);return{err:void 0,qbs:t}}catch(e){return{err:e,qbs:void 0}}}function v(e,r,t,n){if(t!=n){var a=r[t],s=b(a),u=p(a),i=f(t,a,e);!i.query||u>e.tabCount?(i.query&&e.children.push(i),/(A|N)/.test(s)?v(i,r,t+1,n):v(e,r,t+1,n)):v(e.parent,r,t,n)}}function l(e){for(var r=[],t=void 0,n=0;n<e.length;n++)if(e[n]&&!/^\t/.test(e[n])){var a=d(n,e[n],void 0);r.push(a),t&&(t.end=n),t=a}return t.end=n,r}function f(e,r,t){return d(e,r,t)}function d(e,r,t){return{start:e+1,query:r.trim(),end:-1,qType:b(r),children:[],tabCount:p(r),parent:t}}function p(e){for(var r=e.split("\t"),t=0,n=0;n<r.length&&!r[n];n++)t++;return t}function b(e){e=e.trim();var r="";return/:$/.test(e)?(r="N",/\[\]:$/.test(e)&&(r="A")):r="&&"===e||"||"===e?"C":"E",r}var g={validateRegex:function(e,r){var t=r.replace(/\$regex{\/?/,"").replace(/\/?}$/,""),n=new RegExp(t).test(e);return{result:n,verb:n?"":"<b>"+e+"</b> doesn't match the regex pattern specified"}}},h={validateSort:function(e,t){var n=e.slice(0),a=/^\$[ad]sort({(\w+)})?$/.exec(t)[1],s=/asort/.test(t);if(!n)return{result:!1,verb:"Expected an array, found "+n};if(n.length<=1)return{result:0!=n.length,verb:0==n.length?"Empty array found":""};a?"string"==typeof n[0][a]?n.sort(function(e,r){return e[a]<r[a]?s?-1:1:e[a]>r[a]?s?1:-1:0}):n.sort(function(e,r){return s?e[a]-r[a]:r[a]-e[a]}):"string"==typeof n[0]?s?n.sort():n.reverse():n.sort(function(e,r){return s?e-r:r-e});var u=r(e,n,a);return{result:u,verb:u?"":"Expected the array to be sorted in <b>"+(s?"ascending":"descending")+"</b> order "+(a?' based on property <b>"'+a+'"</b>':"")}}},m=/^[0-9a-fA-F]{8}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{12}$/,x={validateUUID:function(e){var r=m.test(e);return{result:r,verb:r?"":"Expected UUID, found "+e}}},y={validateIn:function(e,r){var n=r.replace(/^\$in{/,"").replace(/}$/,""),a=t(n.split(/,\s*/)),s=!0;e[Symbol.iterator]&&"string"!=typeof e||(e=[e]);for(var u of e)if(!a[u]){s=!1;break}return{result:s,verb:s?"":"<b>"+u+"</b> wasn't expected in {"+n+"}"}}},N=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,$={validateIP:function(e){var r=N.test(e);return{result:r,verb:r?"":"Expected IP Address, found "+e}}},q={evaluate:function(e,r,t){if(t=function(e){return'"'===e[0]&&'"'===e[e.length-1]?e.replace(/^"/,"").replace(/"$/,""):e}(t),"="===r)return e==t;if("<>"===r)return e!=t;if("~"===r)return e.indexOf(t)>=0;switch(t=Number(t),e=Number(e),r){case">":return e>t;case">=":return e>=t;case"<":return e<t;case"<=":return e<=t}}};const E=q.evaluate;var A={count:function(e,r){var t,n=0,a=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),s=a[2],u=s.indexOf(":");if(u>=0){var i=s.substr(0,u).trim(),o=s.substr(u+1).trim().replace(/^\//,"").replace(/\/$/,"");t=new RegExp(o),s=i}for(var c of r){var v=c[s];v&&(t?t.test(v)&&n++:n++)}var l=E(n,a[3],a[4]);return{value:n,status:l,verb:l?"":"Count "+n+" didn't match the expected count "+a[4]}}};const L=q.evaluate;var w={sum:function(e,r){var t=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=t[2],a=0;for(var s of r){var u=s[n];if(u){try{u=Number(u)}catch(e){}a+=u}}var i=L(a,t[3],t[4]);return{value:a,status:i,verb:i?"":"Sum "+a+" didn't match the expected sum "+t[4]}}};const I=q.evaluate,R=w.sum;var T={avg:function(e,r){var t=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=R(e,r).value/r.length,a=I(n,t[3],t[4]);return{value:n,status:a,verb:a?"":"Avg "+n+" didn't match the expected avg "+t[4]}}};const k=q.evaluate;var S={min:function(e,r){var t=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=t[2],a=Number.MAX_SAFE_INTEGER;for(var s of r){var u=s[n];if(u){try{u=Number(u)}catch(e){}a>u&&(a=u)}}var i=k(a,t[3],t[4]);return{value:a,status:i,verb:i?"":"Minimum value "+a+" didn't match the expected min "+t[4]}}};const F=q.evaluate;var O={max:function(e,r){var t=/^\$(count|max|min|avg|sum)\{(.+)\}\s(=|<|>|<=|>=)\s(.+)/.exec(e),n=t[2],a=Number.MIN_SAFE_INTEGER;for(var s of r){var u=s[n];if(u){try{u=Number(u)}catch(e){}a<u&&(a=u)}}var i=F(a,t[3],t[4]);return{value:a,status:i,verb:i?"":"Maximum value "+a+" didn't match the expected max "+t[4]}}};const _=g.validateRegex,C=h.validateSort,J=x.validateUUID,U=y.validateIn,M=$.validateIP,P=A.count,j=T.avg,Q=S.min,D=O.max,H=w.sum;var V={getQEValidator:function(e){var r=/^(\$[a-z]+){?/;if(!r.test(e))return null;switch(r.exec(e)[1]){case"$uuid":return J;case"$asort":case"$dsort":return C;case"$regex":return _;case"$in":return U;case"$ip":return M;default:return null}},getAggregationFunction:function(e){var r=/^\$(count|max|min|avg|sum)/.exec(e);if(null==r)return null;switch(r[1]){case"count":return P;case"avg":return j;case"min":return Q;case"max":return D;case"sum":return H;default:return null}},getEmptyResult:function(){return{errLineNo:-1,verb:"",passed:!0,next:"",target:void 0}},traverse:function(e,r){try{for(var t of r)if(t){var n=/\[(\d+)?\]$/.exec(t);null==n?e=e[t]:(e=e[t=t.replace(n[0],"")],void 0!=n[1]&&(e=e[parseInt(n[1])]))}return e}catch(e){return}}};const G=q.evaluate,z=V.getQEValidator,B=V.traverse,K={evaluateExpression:function(e,r,t,a){var s=/\s+([=~<>]+)\s+/.exec(e.q)[1],u=e.q.split(/\s+[=~<>]+\s+/),i=B(r,u[0].split(">")),o=function(e){return e.replace(/^"/,"").replace(/"$/,"")}(u[1]),c=z(o),v=c?c(i,o):G(i,s,o),l="boolean"==typeof v?v:v.result;if(l||(i?t.verb="boolean"!=typeof v?v.verb:n(e.q,u[0],o,i,s):(l=!1,t.verb="Property <b>"+u[0]+"</b> doesn't exist."),t.errLineNo=a.getLineNo()),t.operator=s,t.passed=l,l||"<>"===s){for(var f=r,d=u[0].split(">"),p=0;p<d.length-1;p++)f=f[d[p]];t.target=f,t.errLineNo=a.getLineNo()}return l}}.evaluateExpression;var X={executeTests:a},W={parse:c};const Y=V.getEmptyResult;var Z={consolidateResults:function(e,r){var t=[],n={total:e.length,passed:0},a=[],s=e[0],u=0;for(var i of e){var o=function(e,t,n){return e.passed&&n.passed++,{queryBlock:t+1,status:e.passed,verb:e.verb,line:e.errLineNo,linesToHighlight:function(e){if(!e)return{start:-1,end:-1};var t=JSON.stringify(e,null," ").replace(/\n\s+/g,"\n"),n=JSON.stringify(r,null," ").replace(/\n\s+/g,"\n"),a=n.indexOf(t),s=n.substr(0,a).split("\n").length;return{start:s,end:s-1+t.split("\n").length}}(e.target)}}(i,u,n);t.push(o),a.push({start:o.linesToHighlight.start,end:o.linesToHighlight.end,passed:o.status}),s=function(e,r){var t=Y();if("&&"==e.next)t.passed=e.passed&&r.passed,t.verb=e.passed?r.verb:e.verb,t.errLineNo=e.passed?r.errLineNo:e.errLineNo,t.next=r.next;else{if("||"!=e.next)return e;t.passed=e.passed||r.passed,t.verb=e.passed?r.verb:e.verb,t.errLineNo=e.passed?r.errLineNo:e.errLineNo,t.next=r.next}return t}(s,i),u++}return s.qbs=t,s.overAll=n,s.highlights=a,s}},ee=X.executeTests;const re=Z.consolidateResults;var te=function(e,r){var t=W.parse(r).qbs;return ee(e,t)},ne=function(e,r){var t=W.parse(r).qbs;return re(ee(e,t),e)},ae={validate:te,consolidated:ne};e.consolidated=ne,e.default=ae,e.validate=te,Object.defineProperty(e,"__esModule",{value:!0})});
